---
title: 9. 流水线
icon: hashtag
description: 流水线
tag: riscv
---

使用基于寄存器的时钟同步电路。

在各个流水线阶段之间设置寄存器。

单周期，一次只能处理一条指令。

本次要实现的CPU能始终同时处理5条指令，
因此会存在多个关联信号。

比如在IF ID EX MEM阶段都会出现reg_pc 

第一印象：实现流水线只是在各阶段之间 加入寄存器而已。实际上很简单。

所以第一步就是设置寄存器。

# 设置寄存器 

需要冒险处理

因为指令之间的依赖关系会导致无法正确运行指令。
- 控制冒险
- 数据冒险

流水线停顿，又称气泡。

Chisel如何实现停顿的。
定义Bubble变量的， NOP指令。

需要数据冒险
在可能的情况下实现硬件上直通，其他情况下执行停顿。
forward 

直通，当数据依赖方 的指令已经完成回写数据的计算时，直接读取回写数据。
而不是从 通用寄存器中读取输入数据。

Chisel实现：


- 停顿。
IF和ID两个阶段的处理就需要停顿一个循环。
1. 不为PC计数，维持当前PC。
2. 为IF/ID寄存器输入上一个循环的数值。
3. ID阶段做气泡处理。

实现：
添加stall_flag信号。
。。。






